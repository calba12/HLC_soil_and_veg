---
title: "Dissimilarity above below veg"
author: "Michelle DePrenger-Levin"
date: '2022-09-05'
output: html_document
---

```{r}

install.packages(ggplot)
library(vegan)
library(dplyr)
library(tidyr)
library(ggplot2)
library(dplyr)
```

Dummy data
```{r}
Trans <- 1:9
bank <- c("low","mid","upp")
VegSoil <- c("veg","soil")

df <- expand.grid(Trans,bank,VegSoil)
names(df) <- c("Trans","bank","VegSoil")

df <- df %>%
  group_by(Trans, bank,VegSoil) %>%
  dplyr::summarise(Sp1 = rbinom(n(), size = 1, prob = rbeta(1,1,1)),
                   Sp2 = rbinom(n(), size = 1, prob = rbeta(1,1,1)),
                   Sp3 = rbinom(n(), size = 1, prob = rbeta(1,1,1)),
                   Sp4 = rbinom(n(), size = 1, prob = rbeta(1,1,1)),
                   Sp5 = rbinom(n(), size = 1, prob = rbeta(1,1,1)),
                   Sp6 = rbinom(n(), size = 1, prob = rbeta(1,1,1)))

mds <- metaMDS(df[,-c(1:3)])
data.scores <- as.data.frame(scores(mds))
data.scores$Trans <- df$Trans
data.scores$bank <- df$bank
data.scores$VegSoil <- df$VegSoil

ggplot(data.scores, aes(NMDS1, NMDS2, colour = interaction(bank,VegSoil))) +
  geom_point()+
  stat_ellipse()+
  theme_bw()



braycurtis <- vegdist(df[,-c(1:3)])
as.dist(as.matrix(braycurtis)[df$bank =="low", df$bank == "low"])

## Rarefy and rarecurve for Rarefaction
spAbund <- rowSums(df[,-c(1:3)])
raremin <- min(rowSums(df[,-c(1:3)]))
sRare <- rarefy(df[,-c(1:3)], raremin)
rarecurve(df[,-c(1:3)])

# <https://peat-clark.github.io/BIO381/veganTutorial.html>

## mean within and between block dissimilarities
# diagonal values are mean dissimilarities within VegSoil and off-diagonal mean dissimilarities between different Veg and Soil 
meandist(braycurtis, grouping = df$VegSoil)

# look at differences in number of species
designdist(df[,-c(1:3)], "A-B", "binary")

# row-wise statistics like Shannon-Weaver diversity index
H <- diversity(df[,-c(1:3)]) # can be "simpson" or others
outer(H,H,"-")

## Analysis of variance using distance matrices, partition matrices among sources of variation and fitting linear models
?adonis

ad1 <- adonis(braycurtis ~ bank + VegSoil, data = df)
ad1


```


Convert above ground and soil seed bank data to wide for dissimilarity 
```{r}

veg <- read.csv("./HLC_soil_and_veg/20201204_allHitsData_postQC_prep4.csv")
seedbank <- read.csv("../HLC_soil_and_veg/20220802_HLC_SB_Data_Final4.csv")
getwd("ssh.")

# 1. read in data that is in long format
seedbank <- read.csv("./HLC_soil_and_veg/20220802_HLC_SB_Data_Final4.csv")


aboveground <- read.csv("./HLC_soil_and_veg/20201204_allHitsData_postQC_prep4.csv")

# 2. convert from long to wide
seedbank.wide <- seedbank %>%
  # If you want to remove not (!) when name contains sp., Unknown, or (|) cf. or if NA
  filter(!grepl("sp.|Unknown|cf.|NA",seedbank$SPECIFIC_EPITHET_FINAL),
         !is.na(SPECIFIC_EPITHET_FINAL)) %>%
  pivot_wider(id_cols = c("Full_TrayID"), # can add any other columns that add unique information to set
              names_from = "SPECIFIC_EPITHET_FINAL", # where names for columns come from
              values_from = "SPECIFIC_EPITHET_FINAL",
              values_fn = function(x) sum(!is.na(x)), values_fill = 0) # function to return a count of times the value appeared (and wasn't NA), fill in any others with 0
colnames(seedbank.wide) ## the first column (because only one id_cols) needs to be removed to make the dist matrix seedbank.wide[,-1]


aboveground.wide <- aboveground %>%
  filter(sample.bout == 1,  # you only wanted the first sampling bout
         !is.na(Species.Hit)) %>% # you can add to filter if you don't want the just genus ones 
  pivot_wider(id_cols = c("Transect","baseline.rep","Bank_Location"), # Can add or remove from all the columns that unique identify a transect
              names_from = "Species.Hit",
              values_from = "Species.Hit",
              values_fn = function(x) sum(!is.na(x)), values_fill = 0)
colnames(aboveground.wide) ## Need to remove the first three columns aboveground.wide[,-c(1:3)]

# want all combined and want columns for all the species (or genera) across both
## i. need to make synonomous columns have the same column name 
## I'm assuming that SPECIFIC_EPITHET_FINAL == Species.Hit;
##                   Transect_ID == Transect
##                   Bank_Location == Bank_Location (yay! a sensical one)
## and that that is enough. If you want to have WIS or Functional group or others, follow the same pattern
seedbank <- seedbank %>%
  dplyr::rename(Species.Hit = SPECIFIC_EPITHET_FINAL, ## new name = old name
         Transect = Transect_ID) %>%
  dplyr::mutate(VegSoil = "Soil")

aboveground.1 <- aboveground %>%
  filter(sample.bout == 1,  # you only wanted the first sampling bout
         !is.na(Species.Hit)) %>% # you can add to filter if you don't want the just genus ones 
  dplyr::mutate(VegSoil = "Veg")

species.wide <- bind_rows(seedbank[,c("Transect","Bank_Location","Species.Hit","VegSoil")],
                          aboveground.1[,c("Transect","Bank_Location","Species.Hit","VegSoil")]) %>%
  # filter(Transect %in% c(...list the transects you want for a specific comparison...), VegSoil = "Veg") %>% ## for whatever subsets you want for any given analysis
  pivot_wider(id_cols = c("Transect","VegSoil","Bank_Location"), # Can add or remove from all the columns that unique identify a transect
              names_from = "Species.Hit",
              values_from = "Species.Hit",
              values_fn = function(x) sum(!is.na(x)), values_fill = 0)
## need to remove the first three for vegdist(species.wide[,-c(1:3)]) 

## adjust as needed for whatever analysis you're doing. Keep the first three columns as a data.frame (or tibble) because you'll need them for group arguments

```

